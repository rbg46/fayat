(function () {
  'use strict';

  angular
    .module('Fred')
    .component('ofRessourcesComponent', {
      templateUrl: '/Areas/BilanFlash/Scripts/Ressources/ressources-template.html',
      bindings: {
        resources: '<',
        ciSelected: '<',
        deviseSelected: '<'
      },
      controller: 'ofRessourcesComponentController'
    });

  angular.module('Fred').controller('ofRessourcesComponentController', ofRessourcesComponentController);

  ofRessourcesComponentController.$inject = ['$scope',
                                              'ProgressBar',
                                              'Notify',
                                              'RessourceUpdaterService',
                                              'fredSubscribeService',
                                              'CiManagerService',
                                              'RessourcesDataService'];

  function ofRessourcesComponentController($scope,
                                            ProgressBar,
                                            Notify,
                                            RessourceUpdaterService,
                                            fredSubscribeService,
                                            CiManagerService,
                                            RessourcesDataService) {

    var $ctrl = this;
    var isBusy = false;
    var chapitrePage = 0;
    var chapitrePageSize = 25;
    var canLoadNextPage = true;

    //////////////////////////////////////////////////////////////////
    // Déclaration des propriétés publiques                         //
    //////////////////////////////////////////////////////////////////
    $ctrl.search = '';
    $ctrl.chapitres = [];
    $ctrl.ressourcesAreOpen = false;
    $ctrl.sousChapitreIsOpen = false;

    //////////////////////////////////////////////////////////////////
    // Init                                                         //
    //////////////////////////////////////////////////////////////////
    $ctrl.$onInit = function () {

      fredSubscribeService.subscribe({ eventName: 'objectifFlashCiSlected', callback: actionUpdateRessourcesList });

      RessourceUpdaterService.setChapitres($ctrl.chapitres);

      FredToolBox.bindScrollEnd('#containerRessources', actionLoadMore);
    };

    function actionUpdateRessourcesList() {
      clearRessources();
      canLoadNextPage = true;
      chapitrePage = 0;
      $ctrl.ciSelected = CiManagerService.getCi();
      actionLoad($ctrl.ciSelected);
    }

    //////////////////////////////////////////////////////////////////
    // Public Methods                                               //
    //////////////////////////////////////////////////////////////////
    $ctrl.searchTextChanged = function searchTextChanged() {
      clearRessources();
      canLoadNextPage = true;
      chapitrePage = 0;
      actionLoad($ctrl.ciSelected);
    };

    $ctrl.clickChapitre = function clickChapitre(chapitre) {
      chapitre.isOpen = !chapitre.isOpen;
    };

    $ctrl.clickSousChapitre = function clickSousChapitre(sousChapitre) {
      sousChapitre.isOpen = !sousChapitre.isOpen;
    };

    //////////////////////////////////////////////////////////////////
    // Actions                                                      //
    //////////////////////////////////////////////////////////////////
    function actionLoad(ciSelected) {
      if (!isBusy && ciSelected !== null && canLoadNextPage) {
        isBusy = true;
        ProgressBar.start();
        RessourcesDataService
              .GetChapitres(ciSelected, $ctrl.search, getNextPage(), chapitrePageSize)
              .then(actionLoadSuccess)
              .catch(actionLoadError)
              .finally(actionLoadEnd);
      }
    }


    function actionLoadSuccess(result) {
      if (result.data.length < chapitrePageSize) {
        canLoadNextPage = false;
      }
      for (var i = 0; i < result.data.length; i++) {
        var chapitre = result.data[i];
        for (var j = 0; j < chapitre.SousChapitres.length; j++) {
          var sousChapitres = chapitre.SousChapitres[j];
          sousChapitres.isOpen = false;
        }
        chapitre.isOpen = false;
        $ctrl.chapitres.push(chapitre);
      }
      RessourceUpdaterService.setChapitres($ctrl.chapitres);
    }

    function actionLoadError() {
      Notify.error($ctrl.resources.BudgetRessourcesComponent_actionLoadError);
    }

    function actionLoadEnd() {
      ProgressBar.complete();
      isBusy = false;
    }

    function actionLoadMore() {
      actionLoad($ctrl.ciSelected);
    }

    function clearRessources() {
      $ctrl.chapitres = [];
      RessourceUpdaterService.setChapitres($ctrl.chapitres);
    }

    function getNextPage() {
      var newPage = chapitrePage;
      chapitrePage += 1;
      return newPage;
    }


  }
})();