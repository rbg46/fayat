(function () {
  'use strict';

  angular
    .module('Fred')
    .component('ofRessourceComponent', {
      templateUrl: '/Areas/BilanFlash/Scripts/Ressources/Ressource/ressource-template.html',
      bindings: {
        resources: '<',
        currentRessource: '<',
        chapitre: '<',
        sousChapitre: '<',
        deviseSelected: '<',
        ciSelected: '<'
      },
      controller: 'ofRessourceComponentController'
    });

  angular.module('Fred').controller('ofRessourceComponentController', ofRessourceComponentController);

  ofRessourceComponentController.$inject = ['$scope',
                                              '$uibModal',
                                              'ProgressBar',
                                              'fredSubscribeService',
                                              '$log',
                                              '$timeout',
                                              'ParametrageReferentielEtenduService'];

  function ofRessourceComponentController($scope,
                                            $uibModal,
                                            ProgressBar,
                                            fredSubscribeService,
                                            $log,
                                            $timeout,
                                            ParametrageReferentielEtenduService) {

    var $ctrl = this;

    $ctrl.isBusy = false;

    // permet de savoir si les enfants sont visible ou pas
    $ctrl.isOpen = true;


    //////////////////////////////////////////////////////////////////
    // Init                                                         //
    //////////////////////////////////////////////////////////////////

    $ctrl.$onInit = function () {
      
      manageAllDataAndVisibilityForDevise($ctrl.currentRessource, $ctrl.deviseSelected);
    };

    //////////////////////////////////////////////////////////////////
    // Evenements                                                   //
    //////////////////////////////////////////////////////////////////

    function manageAllDataAndVisibilityForDevise(ressource, deviseSelected) {
      manageAllDataAndVisibilityForDeviseAndRessource(ressource, deviseSelected);

      if (ressource.RessourcesEnfants && ressource.RessourcesEnfants.length > 0) {
        for (var i = 0; i < ressource.RessourcesEnfants.length; i++) {
          var child = ressource.RessourcesEnfants[i];
          manageAllDataAndVisibilityForDeviseAndRessource(child, deviseSelected);
        }
      }

    }

    function manageAllDataAndVisibilityForDeviseAndRessource(ressource, deviseSelected) {
      var hasAnyParametrage = ParametrageReferentielEtenduService.hasAnyParametrageReferentielEtendu(ressource);
      var param = ParametrageReferentielEtenduService.getLastParametrageReferentielEtenduForDeviseByRessource(ressource, deviseSelected);
      if (param) {
        var montant = param.Montant;
        var symbole = param.Devise.Symbole;
        var unite = param.Unite;

        ressource.montant = montant;
        ressource.symbole = symbole;
        ressource.unite = unite;
        ressource.hasAnyParametrages = hasAnyParametrage;
      } else {
        ressource.montant = 0;
        ressource.symbole = null;
        ressource.hasAnyParametrages = hasAnyParametrage;
      }
    }


    //////////////////////////////////////////////////////////////////
    // Actions                                                     //
    //////////////////////////////////////////////////////////////////

    $ctrl.clickHeader = function clickHeader() {
      $ctrl.isOpen = !$ctrl.isOpen;
    };

    $ctrl.clickAddToTask = function clickAddToTask(newRessource) {
      $scope.$emit('objectifFlashRessourceComponent.addRessourceToTask', newRessource);
      fredSubscribeService.raiseEvent('objectifFlashRessourceSlected', newRessource);
    };

  }

})();