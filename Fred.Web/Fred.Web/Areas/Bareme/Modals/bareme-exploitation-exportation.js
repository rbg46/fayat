(function (angular) {
    'use strict';

    angular.module('Fred').component('exportBaremeModal', {
        templateUrl: '/Areas/Bareme/Modals/bareme-exploitation-exportation.html',
        bindings: {
            resolve: '<',
            close: '&',
            dismiss: '&'
        },
        controller: 'exportBaremeModal'
    });

    angular.module('Fred').controller('exportBaremeModal', exportBaremeModal);

    exportBaremeModal.$inject = ['$scope', 'BaremeService', '$filter', 'ProgressBar', 'Notify'];

    function exportBaremeModal($scope, BaremeService, $filter, ProgressBar, Notify) {

        // Initialisation du controller de la modal
        var $ctrl = this;
        $ctrl.listChecked = new Array();
        this.$onInit = function () {
            $ctrl.IsAnySelected = true;
            $ctrl.IsUo = this.resolve.IsUo;
            $ctrl.IsEtablissement = this.resolve.IsEtablissement;
            $ctrl.periode = this.resolve.Period;
            $ctrl.TypeOrganisationId = this.resolve.TypeOrganisationId;
            $ctrl.OrganisationId = this.resolve.OrganisationId;
            $ctrl.isPdfOrganisation = this.resolve.isPdfOrganisation;
            $ctrl.resources = this.resolve.ressources;
            $ctrl.IsAnySelected = true;
            $ctrl.selectedLevels = [];
        };

        $ctrl.handleCancel = function () {
            $scope.$ctrl.dismiss({ $value: 'cancel' });
        };

        $ctrl.onCheckOrga = function (item) {
            const index = $ctrl.selectedLevels.indexOf(item);

            if (index === -1) {
                $ctrl.selectedLevels.push(item);
            } else {
                $ctrl.selectedLevels.splice(index, 1);
            }

            $ctrl.IsAnySelected = $ctrl.selectedLevels.length <= 0;
        };

        $ctrl.Valider = function () {
            $ctrl.onCheckOrga();
            $ctrl.handleExportExcel($ctrl.isPdfOrganisation);
        };

        $ctrl.handleExportExcel = function (isPDF = $ctrl.isPdfOrganisation) {
            $ctrl.listChecked = new Array();
            for (var i = 4; i < 8; i++) {
                var id = "#orga" + i;
                var isCheked = angular.element(document.querySelector(id)).context.checked;
                if (isCheked) {
                    $ctrl.listChecked.push(i);
                }
            }
            var object = {
                period: $filter('date')($ctrl.periode, 'MM-dd-yyyy'),
                levelOfSelectedOrganisation: $ctrl.TypeOrganisationId,
                idSelectedOrganisation: $ctrl.OrganisationId,
                listOfCheckedLevel: $ctrl.listChecked
            };
            ProgressBar.start();
            BaremeService.ExportExcelOrganisation(object, isPDF)
                .then(
                    (result) => { BaremeService.ExtractBaremeOrganisationExcel(result.data.id, isPDF); }
                )
                .catch(error => {
                    Notify.error(isPDF ? $ctrl.resources.BaremeExploitation_ErrorExportPdfMsg : $ctrl.resources.BaremeExploitation_ErrorExportMsg);
                })
                .finally(() => ProgressBar.complete());
        };

    }
}(angular));