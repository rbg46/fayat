(function () {
  'use strict';

  var baremeExploitationHistoriqueComponent = {
    templateUrl: '/Areas/Bareme/Scripts/components/bareme-exploitation-historique.component.html',
    bindings: {
      resources: '<',
      typeSurcharge: '<'
    },
    controller: baremeExploitationHistoriqueController
  };

  angular.module('Fred').component('baremeExploitationHistoriqueComponent', baremeExploitationHistoriqueComponent);

  angular.module('Fred').controller('baremeExploitationHistoriqueController', baremeExploitationHistoriqueController);

  baremeExploitationHistoriqueController.$inject = ['$scope', 'BaremeService'];

  function baremeExploitationHistoriqueController($scope, BaremeService) {

    var $ctrl = this;


    //////////////////////////////////////////////////////////////////
    // Déclaration des membres  publiques                           //
    //////////////////////////////////////////////////////////////////
    $ctrl.GetUniteLibelle = GetUniteLibelle;
    $ctrl.GetPeriodeToString = GetPeriodeToString;
    $ctrl.Hide = Hide;


    //////////////////////////////////////////////////////////////////
    // Initialisation                                               //
    //////////////////////////////////////////////////////////////////
    Hide();

    $ctrl.$onInit = function () {
      $scope.$on('showHistoriqueRequested', function (event, arg) {
        $ctrl.Baremes = arg.Baremes;
        $ctrl.Ressource = arg.Ressource;
        $ctrl.Surcharge = arg.Surcharge;
        Show();
      });
    };


    //////////////////////////////////////////////////////////////////
    // Autre                                                        //
    //////////////////////////////////////////////////////////////////

    // Retourne le libellé de l'unité d'un barème
    function GetUniteLibelle(bareme) {
      return BaremeService.GetUnite(bareme.UniteId).Libelle;
    }

    // Retourne la période sous forme de string
    function GetPeriodeToString(bareme) {
      var ret = "";
      var dateDebut = bareme.PeriodeDebut.split('-');
      var moisDebut = dateDebut[1];
      var anneeDebut = dateDebut[0];
      ret = moisDebut + "/" + anneeDebut;

      if (bareme.PeriodeFin) {
        var dateFin = bareme.PeriodeFin.split('-');
        var moisFin = dateFin[1];
        var anneeFin = dateFin[0];
        if (parseInt(moisFin) === 1) {
          moisFin = "12";
          anneeFin = '' + (anneeFin - 1);
        }
        else {
          moisFin = ('' + (moisFin - 1)).padStart(2, "0");
        }

        if (anneeFin !== anneeDebut || moisFin !== moisDebut) {
          ret += " > " + moisFin + "/" + anneeFin;
        }
      }

      return ret;
    }

    // Ouvre le panneau
    function Show() {
      $ctrl.PanneauHistoriqueClass = "open";
    }

    // Ferme le panneau
    function Hide() {
      $ctrl.PanneauHistoriqueClass = "close-right-panel";
    }
  }
})();
