<!--Veuillez sélectionner une organisation et une période pour afficher le barème organisation-->
<div class="row information" ng-show="!$ctrl.FirstTimeLoaded">
  <div class="col-md-4 icon">
    <i class="flaticon flaticon-warning"></i>
  </div>
  <div class="col-md-4 msg">
    <h3>{{$ctrl.resources.BaremeExploitationOrga_SelectionnerOrganisationEtPeriodePourAfficher}}</h3>
  </div>
</div>

<!--Affiche le barème que s'il a été chargé-->
<fred-flex-table ng-show="$ctrl.Loaded" class="flex-table" id="FLEX_TABLE" anchor-bottom="25">
    <!--Sub-en-tête du barème-->
    <div class="fixed-line-header subentete-ex">
        <div class="col-chapitre fixed-col-header"></div>
        <div class="col-organisation-block"
             ng-repeat="organisation in $ctrl.Organisations track by $index"
             ng-init="organisationSubenteteIndex = $index"
             ng-class="$ctrl.GetOrganisationBlockClass(organisationSubenteteIndex)">
            <div class="col-sep"></div>
            <div class="col-organisation"
                 ng-class="$ctrl.GetOrganisationClass(organisationSubenteteIndex)">
                {{$ctrl.GetTypeOrganisationCodeToDisplay(organisation)}}
                <br />
                {{organisation.Code}}
            </div>
        </div>
    </div>
    <!--En-tête du barème-->
    <div class="fixed-line-header entete-ex">
        <div class="col-chapitre fixed-col-header">{{$ctrl.resources.BaremeExploitation_Code}} / {{$ctrl.resources.BaremeExploitation_Libelle}}</div>
        <div class="col-organisation-block"
             ng-repeat="organisation in $ctrl.Organisations track by $index"
             ng-init="organisationEnteteIndex = $index; organisationEnteteReadOnly = $ctrl.IsReadOnly($index)">
            <div class="col-sep"></div>
            <div class="col-organisation"
                 ng-class="$ctrl.GetOrganisationClass(organisationEnteteIndex)">
                <div ng-if="!organisationEnteteReadOnly" class="composante-first">Prix</div>
                <div ng-if="!organisationEnteteReadOnly" class="composante-next">Unité</div>
                <div ng-if="!organisationEnteteReadOnly" class="composante-next">Chauffeur</div>
                <div ng-if="!organisationEnteteReadOnly" class="composante-next">Conduite</div>
            </div>
        </div>
    </div>

    <!--Liste des chapitres-->
    <div>
        <div ng-repeat="chapitre in $ctrl.Chapitres">
            <div class="flex-line level-1" data-toggle="collapse" aria-expanded="false" data-target="#R1{{chapitre.ChapitreId}}">
                <div class="col-chapitre fixed-col-header">
                    <div class="chevron" ng-attr-data-children="{{chapitre.child.length!=0 ? 'true' : 'false' }}"></div>
                    <span class="icon-R1" title="Chapitre"></span>
                    {{chapitre.Code}} {{chapitre.Libelle}}
                </div>
                <div class="col-organisation-block"
                     ng-repeat="organisation in $ctrl.Organisations track by $index"
                     ng-init="organisationChapitreIndex = $index; organisationChapitreReadOnly = $ctrl.IsReadOnly($index)">
                    <div class="col-sep"></div>
                    <div class="col-organisation"
                         ng-class="$ctrl.GetOrganisationClass(organisationChapitreIndex)">
                        <div class="col-composantes" ng-if="!organisationChapitreReadOnly">

                            <!--Composante 'prix' du barème-->
                            <div class="col-composante">
                                <input type="text"
                                       fred-input-number="3"
                                       min="-999999999999.999"
                                       max="999999999999.999"
                                       class="form-control amount parent"
                                       ng-model="chapitre.Bareme.PrixView"
                                       ng-click="$event.stopPropagation()" />
                            </div>

                            <!--Composante 'unité' du barème-->
                            <div class="col-composante">
                                <select required
                                        class="form-control unite parent"
                                        ng-model="chapitre.Bareme.Unite"
                                        ng-options="unite as unite.Libelle for unite in $ctrl.BaremeService.Unites"
                                        ng-click="$event.stopPropagation()" />
                            </div>

                            <!--Composante 'prix chauffeur' du barème, uniquement pour du matériel-->
                            <div class="col-composante">
                                <input type="text"
                                       fred-input-number="3"
                                       min="-999999999999.999"
                                       max="999999999999.999"
                                       class="form-control amount parent"
                                       ng-model="chapitre.Bareme.PrixChauffeurView"
                                       ng-if="chapitre.IsMateriel"
                                       ng-click="$event.stopPropagation()" />
                            </div>

                            <!--Composante 'prix conduite' du barème, uniquement pour du matériel-->
                            <div class="col-composante">
                                <input type="text"
                                       fred-input-number="3"
                                       min="-999999999999.999"
                                       max="999999999999.999"
                                       class="form-control amount parent"
                                       ng-model="chapitre.Bareme.PrixConduiteView"
                                       ng-if="chapitre.IsMateriel"
                                       ng-click="$event.stopPropagation()" />
                            </div>
                        </div>

                        <div class="col-icon" ng-if="!organisationChapitreReadOnly"></div>
                        <div class="col-icon" ng-if="!organisationChapitreReadOnly"></div>
                        <div class="col-icon" ng-if="!organisationChapitreReadOnly">
                            <!--Bouton Appliquer aux enfants-->
                            <i ng-attr-title="{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfants}}"
                               class="clickable-icon material-icons"
                               aria-hidden="true"
                               ng-click="$event.stopPropagation(); $ctrl.ChapitreToChildren(chapitre)">vertical_align_bottom</i>
                        </div>
                    </div>

                </div>
            </div>

            <!--Liste des sous-chapitres-->
            <div class="collapse in" id="R1{{chapitre.ChapitreId}}">
                <div ng-repeat="sousChapitre in chapitre.SousChapitres">
                    <div class="flex-line level-2" data-toggle="collapse" aria-expanded="false" data-target="#R2{{sousChapitre.SousChapitreId}}">
                        <div class="col-chapitre fixed-col-header">
                            <div class="chevron" ng-attr-data-children="{{sousChapitre.child.length!=0 ? 'true' : 'false' }}"></div>
                            <span class="icon-R2" title="Sous-chapitre"></span>
                            {{sousChapitre.Code}} {{sousChapitre.Libelle}}
                        </div>
                        <div class="col-organisation-block"
                             ng-repeat="organisation in $ctrl.Organisations track by $index"
                             ng-init="organisationSousChapitreIndex = $index; organisationSousChapitreReadOnly = $ctrl.IsReadOnly($index)">
                            <div class="col-sep"></div>
                            <div class="col-organisation"
                                 ng-class="$ctrl.GetOrganisationClass(organisationSousChapitreIndex)">
                                <div class="col-composantes" ng-if="!organisationSousChapitreReadOnly">

                                    <!--Composante 'prix' du barème-->
                                    <div class="col-composante">
                                        <input type="text"
                                               fred-input-number="3"
                                               min="-999999999999.999"
                                               max="999999999999.999"
                                               class="form-control amount parent"
                                               ng-model="sousChapitre.Bareme.PrixView"
                                               ng-click="$event.stopPropagation()" />
                                    </div>

                                    <!--Composante 'unité' du barème-->
                                    <div class="col-composante">
                                        <select required
                                                class="form-control unite parent"
                                                ng-model="sousChapitre.Bareme.Unite"
                                                ng-options="unite as unite.Libelle for unite in $ctrl.BaremeService.Unites"
                                                ng-click="$event.stopPropagation()" />
                                    </div>

                                    <!--Composante 'prix chauffeur' du barème, uniquement pour du matériel-->
                                    <div class="col-composante">
                                        <input type="text"
                                               fred-input-number="3"
                                               min="-999999999999.999"
                                               max="999999999999.999"
                                               class="form-control amount parent"
                                               ng-model="sousChapitre.Bareme.PrixChauffeurView"
                                               ng-if="sousChapitre.IsMateriel"
                                               ng-click="$event.stopPropagation()" />
                                    </div>

                                    <!--Composante 'prix conduite' du barème, uniquement pour du matériel-->
                                    <div class="col-composante">
                                        <input type="text"
                                               fred-input-number="3"
                                               min="-999999999999.999"
                                               max="999999999999.999"
                                               class="form-control amount parent"
                                               ng-model="sousChapitre.Bareme.PrixConduiteView"
                                               ng-if="sousChapitre.IsMateriel"
                                               ng-click="$event.stopPropagation()" />
                                    </div>

                                </div>
                                <div class="col-icon" ng-if="!organisationSousChapitreReadOnly"></div>
                                <div class="col-icon" ng-if="!organisationSousChapitreReadOnly"></div>
                                <div class="col-icon" ng-if="!organisationSousChapitreReadOnly">
                                    <!--Bouton Appliquer aux enfants-->
                                    <i ng-attr-title="{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfants}}"
                                       class="clickable-icon material-icons"
                                       aria-hidden="true"
                                       ng-click="$event.stopPropagation(); $ctrl.SousChapitreToChildren(sousChapitre)">vertical_align_bottom</i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--Liste des ressources-->
                    <div class="collapse in" id="R2{{sousChapitre.SousChapitreId}}">
                        <div ng-repeat="ressource in sousChapitre.Ressources | codeLibelleFilter: $ctrl.search">
                            <div class="flex-line level-3">
                                <div class="col-chapitre fixed-col-header">
                                    <span class="icon-R3" title="Ressource"></span>
                                    {{ressource.Code}} {{ressource.Libelle}}
                                </div>
                                <div class="col-organisation-block"
                                     ng-repeat="bareme in ressource.Baremes track by $index"
                                     ng-init="baremeIndex = $index; baremeReadOnly = $ctrl.IsReadOnly($index)">
                                    <div class="col-sep"></div>
                                    <div class="col-organisation"
                                         ng-class="$ctrl.GetOrganisationClass(baremeIndex)">
                                        <div class="col-composantes" ng-class="$ctrl.GetComposantesClass(bareme)" ng-if="baremeReadOnly">

                                            <!--Texte pour la lecture seul-->
                                            <!--NPI : € est en dur ici, à changer-->
                                            <div class="composante-readonly" ng-if="bareme.CurrentBareme.Unite.UniteId !== $ctrl.BaremeService.DEFAULT_UNITE_ID">
                                                <div ng-if="bareme.CurrentBareme.Prix" class="composante-readonly sub-cln-prix">{{bareme.CurrentBareme.Prix + "€/"}} {{bareme.CurrentBareme.Unite.Libelle}}</div>
                                                <div ng-if="bareme.CurrentBareme.PrixChauffeur" class="composante-readonly sub-cln-chauffeur" ng-attr-title="{{$ctrl.resources.BaremeExploitation_PrixChauffeur}}">{{bareme.CurrentBareme.PrixChauffeur + "€"}}</div>
                                                <div ng-if="bareme.CurrentBareme.PrixConduite" class="composante-readonly sub-cln-conduite" ng-attr-title="{{$ctrl.resources.BaremeExploitation_PrixConduite}}">{{bareme.CurrentBareme.PrixConduite + "€"}}</div>
                                            </div>
                                        </div>
                                        <div class="col-composantes"
                                             ng-class="$ctrl.GetComposantesClass(bareme)"
                                             ng-if="!baremeReadOnly">

                                            <!--Composante 'prix' du barème-->
                                            <div class="col-composante">
                                                <input type="text"
                                                       fred-input-number="3"
                                                       min="-999999999999.999"
                                                       max="999999999999.999"
                                                       class="form-control amount"
                                                       ng-model="bareme.CurrentBareme.PrixView"
                                                       ng-change="bareme.OnChange()" />
                                            </div>

                                            <!--Composante 'unité' du barème-->
                                            <div class="col-composante">
                                                <select required
                                                        class="form-control unite"
                                                        ng-model="bareme.CurrentBareme.Unite"
                                                        ng-options="unite as unite.Libelle for unite in $ctrl.BaremeService.Unites"
                                                        ng-change="bareme.OnChange()"
                                                        ng-disabled="$ctrl.readonly || baremeIndex !== ressource.Baremes.length - 1" />
                                            </div>

                                            <!--Composante 'prix chauffeur' du barème, uniquement pour du matériel-->
                                            <div class="col-composante">
                                                <input type="text"
                                                       fred-input-number="3"
                                                       min="-999999999999.999"
                                                       max="999999999999.999"
                                                       class="form-control amount"
                                                       ng-model="bareme.CurrentBareme.PrixChauffeurView"
                                                       ng-change="bareme.OnChange()"
                                                       ng-if="ressource.IsMateriel"
                                                       ng-disabled="$ctrl.readonly || baremeIndex !== ressource.Baremes.length - 1" />
                                            </div>

                                            <!--Composante 'prix conduite' du barème, uniquement pour du matériel-->
                                            <div class="col-composante">
                                                <input type="text"
                                                       fred-input-number="3"
                                                       min="-999999999999.999"
                                                       max="999999999999.999"
                                                       class="form-control amount"
                                                       ng-model="bareme.CurrentBareme.PrixConduiteView"
                                                       ng-change="bareme.OnChange()"
                                                       ng-if="ressource.IsMateriel"
                                                       ng-disabled="$ctrl.readonly || baremeIndex !== ressource.Baremes.length - 1" />
                                            </div>

                                        </div>
                                        <div class="col-icon" ng-if="!baremeReadOnly" ng-class="bareme.Errors.length === 0 ? '' : 'error'">
                                            <!--Icone 'warning' affichée en cas d'erreur-->
                                            <!--Affiche un tooltip contenant le ou les erreurs-->
                                            <i ng-attr-title="{{$ctrl.BaremeService.GetErrorMessage(bareme)}}"
                                               class="warning-icon material-icons"
                                               aria-hidden="true"
                                               ng-if="bareme.Errors.length !== 0">warning</i>
                                        </div>
                                        <div class="col-icon" ng-if="!baremeReadOnly">
                                            <!--Colonne ressource modifiées-->
                                            <!--Icone indiquant que la ligne a changé depuis la dernière sauvegarde-->
                                            <!--Affiche un tooltip contenant les composantes d'origine-->
                                            <i ng-attr-title="{{$ctrl.BaremeService.GetComposantesOriginaleMessage(bareme)}}"
                                               class="info-icon material-icons"
                                               aria-hidden="true"
                                               ng-if="bareme.Changed">check_circle</i>
                                        </div>
                                        <div class="col-icon" ng-if="!baremeReadOnly">
                                            <!--Voir l'historique-->
                                            <i title="{{$ctrl.resources.BaremeExploitation_Historique_ToolTipIcon}}"
                                               class="clickable-icon material-icons"
                                               aria-hidden="true"
                                               ng-click="$event.stopPropagation(); $ctrl.ShowHistorique(ressource)">more_vert</i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</fred-flex-table>

<!--Historique-->
<bareme-exploitation-historique-component resources="$ctrl.resources"
                                          typeSurcharge="">
</bareme-exploitation-historique-component>

<!--Modal à l'enregistrement d'un barème incomplet-->
<div class="modal fade modal-bareme-incomplet" id="baremeIncompletModal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title"><i class="flaticon flaticon-shuffle-1"></i>{{$ctrl.resources.BaremeExploitation_BaremeIncompletModal_Titre}}</h2>
        <i class="flaticon flaticon-multiply close pull-right" data-dismiss="modal" title="{{$ctrl.resources.BaremeExploitation_BaremeIncompletModal_CompleterLeBareme}}"></i>
      </div>
      <div class="modal-body">
        <b>{{$ctrl.resources.BaremeExploitation_BaremeIncompletModal_Message}}</b>
        <br /><br />
        <!--NPI : € est en dur ici, à changer-->
        <span class="composante-titre">{{$ctrl.resources.BaremeExploitation_Prix}}</span><span class="composante-valeur">{{$ctrl.BaremeService.ValeurParDefaut.Prix + '€'}}</span>
        <br />
        <span class="composante-titre">{{$ctrl.resources.BaremeExploitation_Unite}}</span><span class="composante-valeur">{{$ctrl.BaremeService.ValeurParDefaut.Unite.Libelle}}</span>
        <br />
        <span class="composante-titre">{{$ctrl.resources.BaremeExploitation_PrixChauffeur}}</span><span class="composante-valeur">{{$ctrl.BaremeService.ValeurParDefaut.PrixChauffeur + '€'}}</span>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn  btn-default pull-left btn-rose" data-dismiss="modal" ng-click="$ctrl.RempliComposanteVidesAvecValeurParDefaut()">{{$ctrl.resources.BaremeExploitation_BaremeIncompletModal_AffecterValeurParDefaut}}</button>
        <button type="button" class="btn  btn-link pull-right" data-dismiss="modal">{{$ctrl.resources.BaremeExploitation_BaremeIncompletModal_CompleterLeBareme}}</button>
      </div>
    </div>
  </div>
</div>

<!--Modal pour l'action "appliquer aux enfants" en cas de composante vide-->
<div class="modal fade" id="appliquerAuxEnfantsComposanteVideModal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title"><i class="flaticon flaticon-shuffle-1"></i>{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfantsComposanteVideModal_Titre}}</h2>
        <i class="flaticon flaticon-multiply close pull-right" data-dismiss="modal" title="{{$ctrl.resources.BaremeExploitation_Annuler}}"></i>
      </div>
      <div class="modal-body">
        <b>{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfantsComposanteVideModal_Message}}</b>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default pull-left btn-rose" data-dismiss="modal" ng-click="$ctrl.AppliquerAuxEnfantsComposanteVideModalAction(true)">{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfantsComposanteVideModal_Appliquer}}</button>
        <button type="button" class="btn btn-link pull-right" data-dismiss="modal" ng-click="$ctrl.AppliquerAuxEnfantsComposanteVideModalAction(false)">{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfantsComposanteVideModal_Ignorer}}</button>
      </div>
    </div>
  </div>
</div>
