<!--Veuillez sélectionner une affaire et une période pour afficher le barème CI-->
<div class="row information" ng-show="!$ctrl.FirstTimeLoaded">
  <div class="col-md-4 icon">
    <i class="flaticon flaticon-warning"></i>
  </div>
  <div class="col-md-4 msg">
    <h3>{{$ctrl.resources.BaremeExploitationCI_SelectionnerAffaireEtPeriodePourAfficher}}</h3>
  </div>
</div>

<!--Affiche le barème que s'il a été chargé-->
<fred-flex-table ng-show="$ctrl.Loaded" class="flex-table" id="FLEX_TABLE" anchor-bottom="25">
  <!--Sub-en-tête du barème-->
  <div class="fixed-line-header subentete-ex">
    <div class="col-1 fixed-col-header"></div>
    <div class="col-2">{{$ctrl.resources.BaremeExploitation_RessourceModifiee}}</div>
    <div class="col-sep"></div>
    <div class="col-3">{{$ctrl.resources.BaremeExploitation_RappelBaremeOrganisation}}</div>
    <div class="col-sep"></div>
    <div class="col-4">{{$ctrl.resources.BaremeExploitation_BaremeExploitation}}</div>
    <div class="col-5"></div>
    <div class="col-6"></div>
    <div class="col-7"></div>
    <div class="col-8"></div>
    <div class="col-sep col-sep-8-9"></div>
    <div class="col-9"></div>
  </div>

  <!--En-tête du barème-->
  <div class="fixed-line-header entete-ex">
    <div class="col-1 fixed-col-header">{{$ctrl.resources.BaremeExploitation_Code}} / {{$ctrl.resources.BaremeExploitation_Libelle}}</div>
    <div class="col-2"></div>
    <div class="col-sep"></div>
    <div class="col-3"></div>
    <div class="col-sep"></div>
    <div class="col-4">{{$ctrl.resources.BaremeExploitation_Prix}}</div>
    <div class="col-5">{{$ctrl.resources.BaremeExploitation_Unite}}</div>
    <div class="col-6">{{$ctrl.resources.BaremeExploitation_Chauffeur}}</div>
    <div class="col-7">{{$ctrl.resources.BaremeExploitation_Conduite}}</div>
    <div class="col-8"></div>
    <div class="col-sep"></div>
    <div class="col-9">{{$ctrl.resources.BaremeExploitation_Action}}</div>
  </div>

  <!--Liste des chapitres-->
  <div ng-repeat="chapitre in $ctrl.Chapitres">
    <div class="flex-line level-1" data-toggle="collapse" aria-expanded="false" data-target="#R1{{chapitre.ChapitreId}}">
      <div class="col-1 fixed-col-header">
        <div class="chevron" ng-attr-data-children="{{chapitre.child.length!=0 ? 'true' : 'false' }}"></div>
        <span class="icon-R1" ng-attr-title="{{$ctrl.resources.BaremeExploitation_Chapitre_Tooltip}}"></span>
        {{chapitre.Code}} {{chapitre.Libelle}}
      </div>
      <div class="col-2"></div>
      <div class="col-sep"></div>
      <div class="col-3"></div>
      <div class="col-sep"></div>

      <!--Composante 'prix' du barème-->
      <div class="col-4">
        <input type="text"
               fred-input-number="3"
               min="-999999999999.999"
               max="999999999999.999"
               class="form-control amount parent"
               ng-model="chapitre.Bareme.PrixView"
               ng-if="!chapitre.IsReadonly"
               ng-click="$event.stopPropagation()" />
      </div>

      <!--Composante 'unité' du barème-->
      <div class="col-5">
        <select required
                class="form-control unite parent"
                ng-model="chapitre.Bareme.Unite"
                ng-options="unite as unite.Libelle for unite in $ctrl.BaremeService.Unites"
                ng-if="!chapitre.IsReadonly"
                ng-click="$event.stopPropagation()" />
      </div>

      <!--Composante 'prix chauffeur' du barème, uniquement pour du matériel-->
      <div class="col-6">
        <input type="text"
               fred-input-number="3"
               min="-999999999999.999"
               max="999999999999.999"
               class="form-control amount parent"
               ng-model="chapitre.Bareme.PrixChauffeurView"
               ng-if="chapitre.IsMateriel && !chapitre.IsReadonly"
               ng-click="$event.stopPropagation()" />
      </div>

      <!--Composante 'prix conduite' du barème, uniquement pour du matériel-->
      <div class="col-7">
        <input type="text"
               fred-input-number="3"
               min="-999999999999.999"
               max="999999999999.999"
               class="form-control amount parent"
               ng-model="chapitre.Bareme.PrixConduiteView"
               ng-if="chapitre.IsMateriel && !chapitre.IsReadonly"
               ng-click="$event.stopPropagation()" />
      </div>

      <div class="col-8"></div>
      <div class="col-sep" ng-click="$event.stopPropagation()"></div>

      <!--Bouton Appliquer aux enfants-->
      <div class="col-9" ng-click="$event.stopPropagation()">
        <i ng-attr-title="{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfants}}"
           class="clickable-icon material-icons"
           aria-hidden="true"
           ng-if="!chapitre.IsReadonly"
           ng-click="$event.stopPropagation(); $ctrl.ChapitreToChildren(chapitre)">vertical_align_bottom</i>
      </div>
    </div>

    <!--Liste des sous-chapitres-->
    <div class="collapse in" id="R1{{chapitre.ChapitreId}}">
      <div ng-repeat="sousChapitre in chapitre.SousChapitres">
        <div class="flex-line level-2" data-toggle="collapse" aria-expanded="false" data-target="#R2{{sousChapitre.SousChapitreId}}">
          <div class="col-1 fixed-col-header">
            <div class="chevron" ng-attr-data-children="{{sousChapitre.child.length!=0 ? 'true' : 'false' }}"></div>
            <span class="icon-R2" ng-attr-title="{{$ctrl.resources.BaremeExploitation_SousChapitre_Tooltip}}"></span>
            {{sousChapitre.Code}} {{sousChapitre.Libelle}}
          </div>
          <div class="col-2"></div>
          <div class="col-sep"></div>
          <div class="col-3"></div>
          <div class="col-sep"></div>

          <!--Composante 'prix' du barème-->
          <div class="col-4">
            <input type="text"
                   fred-input-number="3"
                   min="-999999999999.999"
                   max="999999999999.999"
                   class="form-control amount parent"
                   ng-model="sousChapitre.Bareme.PrixView"
                   ng-if="!sousChapitre.IsReadonly"
                   ng-click="$event.stopPropagation()" />
          </div>

          <!--Composante 'unité' du barème-->
          <div class="col-5">
            <select required
                    class="form-control unite parent"
                    ng-model="sousChapitre.Bareme.Unite"
                    ng-options="unite as unite.Libelle for unite in $ctrl.BaremeService.Unites"
                    ng-if="!sousChapitre.IsReadonly"
                    ng-click="$event.stopPropagation()" />
          </div>

          <!--Composante 'prix chauffeur' du barème, uniquement pour du matériel-->
          <div class="col-6">
            <input type="text"
                   fred-input-number="3"
                   min="-999999999999.999"
                   max="999999999999.999"
                   class="form-control amount parent"
                   ng-model="sousChapitre.Bareme.PrixChauffeurView"
                   ng-if="sousChapitre.IsMateriel && !sousChapitre.IsReadonly"
                   ng-click="$event.stopPropagation()" />
          </div>

          <!--Composante 'prix conduite' du barème, uniquement pour du matériel-->
          <div class="col-7">
            <input type="text"
                   fred-input-number="3"
                   min="-999999999999.999"
                   max="999999999999.999"
                   class="form-control amount parent"
                   ng-model="sousChapitre.Bareme.PrixConduiteView"
                   ng-if="sousChapitre.IsMateriel && !sousChapitre.IsReadonly"
                   ng-click="$event.stopPropagation()" />
          </div>

          <div class="col-8"></div>
          <div class="col-sep" ng-click="$event.stopPropagation()"></div>

          <!--Bouton Appliquer aux enfants-->
          <div class="col-9" ng-click="$event.stopPropagation()">
            <i ng-attr-title="{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfants}}"
               class="clickable-icon material-icons"
               aria-hidden="true"
               ng-if="!sousChapitre.IsReadonly"
               ng-click="$event.stopPropagation(); $ctrl.SousChapitreToChildren(sousChapitre)">vertical_align_bottom</i>
          </div>
        </div>

        <!--Liste des ressources-->
        <div class="collapse in" id="R2{{sousChapitre.SousChapitreId}}">
          <div ng-repeat="ressource in sousChapitre.Ressources | codeLibelleFilter: $ctrl.search">
            <div class="flex-line level-3">
              <div class="col-1 fixed-col-header">
                <span class="icon-R3" ng-attr-title="{{$ctrl.resources.BaremeExploitation_Ressource_Tooltip}}"></span>
                {{ressource.Code}} {{ressource.Libelle}}
              </div>

              <!--Colonne Ressource modifiées-->
              <!--Icone indiquant que la ligne a changé depuis la dernière sauvegarde-->
              <!--Affiche un tooltip contenant les composantes d'origine-->
              <div class="col-2">
                <div ng-if="ressource.Changed">
                  <i ng-attr-title="{{$ctrl.BaremeService.GetComposantesOriginaleMessage(ressource)}}" class="info-icon material-icons" aria-hidden="true">check_circle</i>
                </div>
              </div>

              <div class="col-sep"></div>

              <!--Rappel du barème organisation-->
              <div class="col-3">
                <span class="bdg storm"
                      ng-if="ressource.IsStorm && !$ctrl.readonly"
                      ng-attr-title="{{$ctrl.resources.BaremeExploitationCI_RessourceStormLectureSeule_TooltipIcon}}">{{$ctrl.resources.Global_Storm}}</span>
                <span class="bdg storm"
                      ng-if="ressource.IsStorm && $ctrl.readonly">{{$ctrl.resources.Global_Storm}}</span>
                <div ng-if="!ressource.IsStorm && $ctrl.IsBaremeCiDifferentBaremeOrganisation(ressource)">
                  <i ng-attr-title="{{$ctrl.GetRappelBaremeOrganisationMessage(ressource)}}" class="info-icon material-icons" aria-hidden="true">check_circle</i>
                </div>
              </div>

              <div class="col-sep"></div>

              <!--Composante 'prix' de la ressource-->
              <div class="col-4" ng-class="ressource.Errors.length === 0 ? '' : 'error'">
                <input type="text"
                       fred-input-number="3"
                       min="-999999999999.999"
                       max="999999999999.999"
                       class="form-control amount"
                       ng-model="ressource.CurrentBareme.PrixView"
                       ng-change="ressource.OnChange()"
                       ng-disabled="$ctrl.readonly || ressource.IsStorm"
                       ng-attr-title="{{$ctrl.GetRessourceComposanteTooltip(ressource)}}" />
              </div>

              <!--Composante 'unité' de la ressource-->
              <div class="col-5" ng-class="ressource.Errors.length === 0 ? '' : 'error'">
                <select required
                        class="form-control unite"
                        ng-model="ressource.CurrentBareme.Unite"
                        ng-options="unite as unite.Libelle for unite in $ctrl.BaremeService.Unites"
                        ng-change="ressource.OnChange()"
                        ng-disabled="$ctrl.readonly || ressource.IsStorm"
                        ng-attr-title="{{$ctrl.GetRessourceComposanteTooltip(ressource)}}" />
              </div>

              <!--Composante 'prix chauffeur' de la ressource, uniquement pour du matériel-->
              <div class="col-6" ng-class="ressource.Errors.length === 0 ? '' : 'error'">
                <input type="text"
                       fred-input-number="3"
                       min="-999999999999.999"
                       max="999999999999.999"
                       class="form-control amount"
                       ng-model="ressource.CurrentBareme.PrixChauffeurView"
                       ng-change="ressource.OnChange()"
                       ng-if="ressource.IsMateriel"
                       ng-disabled="$ctrl.readonly || ressource.IsStorm"
                       ng-attr-title="{{$ctrl.GetRessourceComposanteTooltip(ressource)}}" />
              </div>

              <!--Composante 'prix conduite' de la ressource, uniquement pour du matériel-->
              <div class="col-7" ng-class="ressource.Errors.length === 0 ? '' : 'error'">
                <input type="text"
                       fred-input-number="3"
                       min="-999999999999.999"
                       max="999999999999.999"
                       class="form-control amount"
                       ng-model="ressource.CurrentBareme.PrixConduiteView"
                       ng-change="ressource.OnChange()"
                       ng-if="ressource.IsMateriel"
                       ng-disabled="$ctrl.readonly || ressource.IsStorm"
                       ng-attr-title="{{$ctrl.GetRessourceComposanteTooltip(ressource)}}" />
              </div>

              <!--Icone 'warning' affichée en cas d'erreur-->
              <!--Affiche un tooltip contenant le ou les erreurs-->
              <div class="col-8" ng-class="ressource.Errors.length === 0 ? '' : 'error'">
                <div ng-if="ressource.Errors.length !== 0">
                  <i ng-attr-title="{{$ctrl.BaremeService.GetErrorMessage(ressource)}}" class="warning-icon material-icons" aria-hidden="true">warning</i>
                </div>
              </div>

              <div class="col-sep"></div>
              <div class="col-9">
                  <div class="action-icon">
                      <!-- sélection du personnel lors de l'ajout d'une surcharge ou d'une exception dont la ressource est typée 'personnel'-->
                      <lookup-standalone ng-model="personnel"
                                         ng-if="ressource.IsPersonnel"
                                         search-title="{{$ctrl.resources.Global_ReferentielPersonnel}}"
                                         search-placeholder="{{$ctrl.resources.Personnel_PartialGeneral_Nom_Placeholder}}"
                                         search-placeholder2="{{$ctrl.resources.Personnel_PartialGeneral_Prenom_Placeholder}}"
                                         search-placeholder3="{{$ctrl.resources.Personnel_Filter_Autre_Information_Placeholder}}"
                                         on-select="$ctrl.AddSurchagePersonnel(ressource, personnel)"
                                         url="/api/Personnel/SearchLight/?IncludeInterimaire=false&CiId={{$ctrl.ci.CiId}}&"
                                         active-second-search-input="true" active-third-search-input="true" add-Personel-Icon="true">
                          <i ng-attr-title="{{$ctrl.resources.BaremeExploitationCI_AjoutSurchargePersonnel}}"
                             class="clickable-icon material-icons"
                             aria-hidden="true"
                             ng-show="!$ctrl.readonly">person_add</i>
                      </lookup-standalone>

                      <!--A FAIRE : ci.Sep-->
                      <!--Lookup de sélection du matériel pour les CI non SEP lors de l'ajout d'une surcharge ou d'une exception dont la ressource est typée 'matériel'-->
                      <lookup ng-model="materiel"
                              ng-if="!$ctrl.readonly && ressource.IsMateriel"
                              search-placeholder="{{$ctrl.resources.Global_ReferentielMateriel_Placeholder}}"
                              search-title="{{$ctrl.resources.Global_ReferentielMateriel}}"
                              on-select="$ctrl.AddSurchageMateriel(ressource, materiel)"
                              url="/api/Materiel/SearchLight/?CiId={{$ctrl.ci.CiId}}&"
                              ng-disabled="ressource.IsStorm">
                          <i ng-attr-title="{{$ctrl.GetRessourceAjouterSurchargeMaterielTooltip(ressource, true)}}"
                             ng-class="ressource.IsStorm ? 'materiel-off-icon' : 'materiel-on-icon'"
                             class="material-icons"
                             aria-hidden="true"
                             ng-disabled="ressource.IsStorm"></i>
                      </lookup>
                  </div>

                <!--Voir l'historique-->
                <div class="action-icon">
                  <i title="{{$ctrl.resources.BaremeExploitation_Historique_ToolTipIcon}}"
                     class="clickable-icon material-icons"
                     aria-hidden="true"
                     ng-click="$event.stopPropagation(); $ctrl.ShowRessourceHistorique(ressource)">more_vert</i>
                </div>
              </div>
            </div>

            <!--Liste des surcharges et exceptions-->
            <div ng-repeat="surcharge in ressource.Surcharges | filter: {Deleted: false}">
              <div class="flex-line level-4">
                <div class="col-1 fixed-col-header">
                  <span class="icon-R3MO" ng-if="ressource.IsPersonnel" ng-attr-title="{{$ctrl.resources.BaremeExploitation_RessourceMO_Tooltip}}"></span>
                  <span class="icon-R3MA" ng-if="ressource.IsMateriel" ng-attr-title="{{$ctrl.resources.BaremeExploitation_RessourceMateriel_Tooltip}}"></span>
                  {{surcharge.Matricule}} {{surcharge.Libelle}}
                </div>

                <!--Colonne Ressource modifiées-->
                <!--Icone indiquant que la ligne a changé depuis la dernière sauvegarde-->
                <!--Affiche un tooltip contenant les composantes d'origine-->
                <div class="col-2">
                  <div ng-if="surcharge.Changed">
                    <i ng-attr-title="{{$ctrl.BaremeService.GetComposantesOriginaleMessage(surcharge)}}" class="info-icon material-icons" aria-hidden="true">check_circle</i>
                  </div>
                </div>

                <div class="col-sep"></div>
                <div class="col-3"></div>
                <div class="col-sep"></div>

                <!--Composante 'prix' de la surcharge ou de l'exception-->
                <div class="col-4" ng-class="surcharge.Errors.length === 0 ? '' : 'error'">
                  <input type="text"
                         fred-input-number="3"
                         min="-999999999999.999"
                         max="999999999999.999"
                         class="form-control amount"
                         ng-model="surcharge.CurrentBareme.PrixView"
                         ng-change="surcharge.OnChange()"
                         ng-disabled="$ctrl.readonly" />
                </div>

                <!--Composante 'unité' de la surcharge ou de l'exception-->
                <div class="col-5" ng-class="surcharge.Errors.length === 0 ? '' : 'error'">
                  <select required
                          class="form-control unite"
                          ng-model="surcharge.CurrentBareme.Unite"
                          ng-options="unite as unite.Libelle for unite in $ctrl.BaremeService.Unites"
                          ng-change="surcharge.OnChange()"
                          ng-disabled="$ctrl.readonly" />
                </div>

                <!--Composante 'prix chauffeur' de la surcharge ou de l'exception, uniquement pour du matériel-->
                <div class="col-6" ng-class="surcharge.Errors.length === 0 ? '' : 'error'">
                  <input type="text"
                         fred-input-number="3"
                         min="-999999999999.999"
                         max="999999999999.999"
                         class="form-control amount"
                         ng-model="surcharge.CurrentBareme.PrixChauffeurView"
                         ng-change="surcharge.OnChange()"
                         ng-if="surcharge.IsMateriel"
                         ng-disabled="$ctrl.readonly" />
                </div>

                <!--Composante 'prix conduite' de la surcharge ou de l'exception, uniquement pour du matériel-->
                <div class="col-7" ng-class="surcharge.Errors.length === 0 ? '' : 'error'">
                  <input type="text"
                         fred-input-number="3"
                         min="-999999999999.999"
                         max="999999999999.999"
                         class="form-control amount"
                         ng-model="surcharge.CurrentBareme.PrixConduiteView"
                         ng-change="surcharge.OnChange()"
                         ng-if="surcharge.IsMateriel"
                         ng-disabled="$ctrl.readonly" />
                </div>

                <!--Icone 'warning' affichée en cas d'erreur-->
                <!--Affiche un tooltip contenant le ou les erreurs-->
                <div class="col-8" ng-class="surcharge.Errors.length === 0 ? '' : 'error'">
                  <div ng-if="surcharge.Errors.length !== 0">
                    <i ng-attr-title="{{$ctrl.BaremeService.GetErrorMessage(surcharge)}}" class="warning-icon material-icons" aria-hidden="true">warning</i>
                  </div>
                </div>

                <div class="col-sep"></div>
                <div class="col-9">
                  <!--Bouton pour supprimer la surcharge ou l'exception-->
                  <div class="action-icon">
                    <i title="{{$ctrl.resources.BaremeExploitationCI_SupprimerSurcharge_TootipIcon}}"
                       class="clickable-icon material-icons"
                       aria-hidden="true"
                       ng-click="$ctrl.DeleteSurcharge(surcharge)"
                       ng-if="!$ctrl.readonly && !ressource.IsStorm">close</i>
                  </div>

                  <!--Voir l'historique-->
                  <div class="action-icon">
                    <i title="{{$ctrl.resources.BaremeExploitation_Historique_ToolTipIcon}}"
                       class="clickable-icon material-icons"
                       aria-hidden="true"
                       ng-click="$event.stopPropagation(); $ctrl.ShowSurchargeHistorique(surcharge)">more_vert</i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</fred-flex-table>

<!--Historique-->
<bareme-exploitation-historique-component resources="$ctrl.resources"
                                          type-surcharge="$ctrl.typeSurcharge">
</bareme-exploitation-historique-component>

<!--Modal à l'enregistrement d'un barème incomplet-->
<div class="modal fade modal-bareme-incomplet" id="baremeIncompletModal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title"><i class="flaticon flaticon-shuffle-1"></i>{{$ctrl.resources.BaremeExploitation_BaremeIncompletModal_Titre}}</h2>
        <i class="flaticon flaticon-multiply close pull-right" data-dismiss="modal" title="{{$ctrl.resources.BaremeExploitation_Annuler}}"></i>
      </div>
      <div class="modal-body">
        <b>{{$ctrl.resources.BaremeExploitation_BaremeIncompletModal_Message}}</b>
        <br /><br />
        <!--NPI : € est en dur ici, à changer-->
        <span class="composante-titre">{{$ctrl.resources.BaremeExploitation_Prix}}</span><span class="composante-valeur">{{$ctrl.BaremeService.ValeurParDefaut.Prix + '€'}}</span>
        <br />
        <span class="composante-titre">{{$ctrl.resources.BaremeExploitation_Unite}}</span><span class="composante-valeur">{{$ctrl.BaremeService.ValeurParDefaut.Unite.Libelle}}</span>
        <br />
        <span class="composante-titre">{{$ctrl.resources.BaremeExploitation_PrixChauffeur}}</span><span class="composante-valeur">{{$ctrl.BaremeService.ValeurParDefaut.PrixChauffeur + '€'}}</span>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default pull-left btn-rose" data-dismiss="modal" ng-click="$ctrl.RempliComposanteVidesAvecValeurParDefaut()">{{$ctrl.resources.BaremeExploitation_BaremeIncompletModal_AffecterValeurParDefaut}}</button>
        <button type="button" class="btn btn-link pull-right" data-dismiss="modal">{{$ctrl.resources.BaremeExploitation_BaremeIncompletModal_CompleterLeBareme}}</button>
      </div>
    </div>
  </div>
</div>

<!--Modal pour l'action "appliquer aux enfants" en cas de composante vide-->
<div class="modal fade" id="appliquerAuxEnfantsComposanteVideModal" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title"><i class="flaticon flaticon-shuffle-1"></i>{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfantsComposanteVideModal_Titre}}</h2>
        <i class="flaticon flaticon-multiply close pull-right" data-dismiss="modal" title="{{$ctrl.resources.BaremeExploitation_Annuler}}"></i>
      </div>
      <div class="modal-body">
        <b>{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfantsComposanteVideModal_Message}}</b>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default pull-left btn-rose" data-dismiss="modal" ng-click="$ctrl.AppliquerAuxEnfantsComposanteVideModalAction(true)">{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfantsComposanteVideModal_Appliquer}}</button>
        <button type="button" class="btn btn-link pull-right" data-dismiss="modal" ng-click="$ctrl.AppliquerAuxEnfantsComposanteVideModalAction(false)">{{$ctrl.resources.BaremeExploitation_AppliquerAuxEnfantsComposanteVideModal_Ignorer}}</button>
      </div>
    </div>
  </div>
</div>
