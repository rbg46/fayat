using Fred.Entities.ReferentielFixe;
using System;
using System.Collections.Generic;
using static Fred.Entities.Constantes;

namespace Fred.Business.BaremeExploitation
{
    /// <summary>
    /// Helper pour les barèmes exploitation.
    /// </summary>
    public static class BaremeExploitationManagerHelper
    {
        /// <summary>
        /// Retourne une liste contenant uniquement les chapitres et sous-chapitres contenant des ressources MO et matériel.
        /// </summary>
        /// <param name="allChapitres">Chapitres concernée.</param>
        /// <returns>La liste contenant uniquement les chapitres et sous-chapitres contenant des ressources MO et matériel</returns>
        public static List<ChapitreEnt> GetReferentielMaterielEtMO(IEnumerable<ChapitreEnt> allChapitres)
        {
            var ret = new List<ChapitreEnt>();

            foreach (var chapitre in allChapitres)
            {
                var sousChapitres = new List<SousChapitreEnt>();
                foreach (var sousChapitre in chapitre.SousChapitres)
                {
                    var ressources = new List<RessourceEnt>();
                    foreach (var ressource in sousChapitre.Ressources)
                    {
                        if (IsRessourceMaterielOrMO(ressource) && !IsRessourceODOrLitige(ressource))
                        {
                            ressources.Add(ressource);
                        }
                    }

                    if (ressources.Count > 0)
                    {
                        sousChapitre.Ressources = ressources;
                        sousChapitres.Add(sousChapitre);
                    }
                }

                if (sousChapitres.Count > 0)
                {
                    chapitre.SousChapitres = sousChapitres;
                    ret.Add(chapitre);
                }
            }

            return ret;
        }

        /// <summary>
        /// Indique si une ressource est de type MO ou matériel.
        /// </summary>
        /// <param name="ressource">La ressource concernée.</param>
        /// <returns>True si la ressource est de type MO ou matériel, sinon false.</returns>
        private static bool IsRessourceMaterielOrMO(RessourceEnt ressource)
        {
            return ressource.TypeRessource != null && (ressource.TypeRessource.Code == TypeRessource.CodeTypePersonnel || ressource.TypeRessource.Code == TypeRessource.CodeTypeMateriel);
        }

        private static bool IsRessourceODOrLitige(RessourceEnt ressource)
        {
            return StartsWith("OD ") || StartsWith("LITIGE ");

            bool StartsWith(string prefix) => ressource.Libelle.StartsWith(prefix, StringComparison.CurrentCultureIgnoreCase);
        }
    }
}
