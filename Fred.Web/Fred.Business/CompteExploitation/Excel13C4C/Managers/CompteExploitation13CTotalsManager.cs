using System;
using System.Collections.Generic;
using System.Globalization;
using Fred.Business.Budget;
using Fred.Business.CompteExploitation.Excel13C4C.Calculators;
using Fred.Business.CompteExploitation.Excel13C4C.Managers.Interfaces;
using Fred.Business.CompteExploitation.Excel13C4C.Models;
using Fred.Web.Shared.Enum;
using Fred.Web.Shared.Models.Budget.Recette;
namespace Fred.Business.CompteExploitation.Excel13C4C.Managers
{
    public class CompteExploitation13CTotalsManager : ICompteExploitation13CTotalsManager
    {
        private readonly IBudgetMainManager budgetMainManager;


        public CompteExploitation13CTotalsManager(IBudgetMainManager budgetMainManager)
        {
            this.budgetMainManager = budgetMainManager;
        }

        public CompteExploitation13CTotalsResult GetTotals(int ciId, DateTime periodeFin)
        {
            var result = new CompteExploitation13CTotalsResult();

            // Calcul des totaux
            CultureInfo culture = CultureInfo.CurrentCulture;

            int toDate = int.Parse(periodeFin.ToString("yyyyMM", culture), culture);

            int fromDate = int.Parse(periodeFin.AddMonths(-12).ToString("yyyyMM", culture), culture);

            List<PeriodAvancementRecetteLoadModel> periodAvancementRecetteLoadModels = budgetMainManager.GetAvancementRecettesForPeriode(ciId, fromDate, toDate);

            CommonsTotalsCalculator commonsTotalsCalculator = new CommonsTotalsCalculator();

            ResultYear facture = commonsTotalsCalculator.CreateRows13C(periodAvancementRecetteLoadModels, toDate, InfoAvancementRecette.facture);

            ResultYear correctif = commonsTotalsCalculator.CreateRows13C(periodAvancementRecetteLoadModels, toDate, InfoAvancementRecette.correctif);

            ResultYear production = commonsTotalsCalculator.CreateRows13C(periodAvancementRecetteLoadModels, toDate, InfoAvancementRecette.production);

            FraisGenerauxTotalsCalculator fraixGenerauxTotalsCalculator = new FraisGenerauxTotalsCalculator();

            Result13C fraisPorp13C = fraixGenerauxTotalsCalculator.GetComputedYearForFraixGeneraux13C(periodAvancementRecetteLoadModels, toDate);

            ////TOTAL FACTURATION (colonnes)=> A  B  C
            //// A =  C - B
            //// B =  excel4CContainer.Facture.MontantM11
            //// C =  excel4CContainer.Facture.MontantCumul
            result.Facture = facture;

            ////CORRECTIF (colonnes)=> A  B  C
            //// A =  C - B
            //// B =  excel4CContainer.Correctif.MontantM11
            //// C =  excel4CContainer.Correctif.MontantCumul
            result.Correctif = correctif;

            //// PRODUCTION (colonnes)=> A  B  C
            //// A =  C - B
            //// B =  excel4CContainer.Production.MontantM11
            //// C =  excel4CContainer.Production.MontantCumul
            result.Production = production;

            //// FRAIS PROPORTIONNEL (colonnes)=> A  B  C
            //// A =  C - B
            //// B =  excel4CContainer.FraisPorp.MontantM11
            //// C =  excel4CContainer.FraisPorp.MontantCumul
            result.FraisPorp = fraisPorp13C;

            return result;
        }


    }
}
