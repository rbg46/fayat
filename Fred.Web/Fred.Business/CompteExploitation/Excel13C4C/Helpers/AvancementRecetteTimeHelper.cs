using System;
using System.Collections.Generic;
using System.Globalization;
using System.Linq;
using Fred.Web.Shared.Models.Budget.Recette;

namespace Fred.Business.CompteExploitation.Excel13C4C.Helpers
{
    public class AvancementRecetteTimeHelper
    {
        public int GetMonthAsInteger(int period, int substractMonth)
        {
            var periodTemp = period - substractMonth;

            DateTime validPeriod = DateTime.MinValue;

            while (!DateTime.TryParseExact(GetStringDate(periodTemp), "dd/MM/yyyy", CultureInfo.InvariantCulture, DateTimeStyles.None, out validPeriod))
            {
                //-100 pour l'année
                //+12 pour les mois
                periodTemp = periodTemp - 100 + 12;
            }

            return int.Parse(validPeriod.Year + "" + validPeriod.Month.ToString().PadLeft(2, '0'));
        }

        private static string GetStringDate(int periodTemp)
        {
            return "01/" + periodTemp.ToString().Substring(4, 2) + "/" + periodTemp.ToString().Substring(0, 4);
        }


        public AvancementRecetteLoadModel GetAvancementRecetteForPeriod(List<PeriodAvancementRecetteLoadModel> periodAvancementRecetteLoadModels, int basePeriod, int substractMonth)
        {
            var month = GetMonthAsInteger(basePeriod, substractMonth);
            var avancement = periodAvancementRecetteLoadModels.Where(x => x.PeriodRequested == month).FirstOrDefault();
            return avancement.AvancementRecetteLoadModel;
        }
    }
}
